version: 1
# Top-level frontend section for global setup and cache
frontend:
  phases:
    preBuild:
      commands:
        # Specify Node version (Amplify uses nvm)
        - echo "Selecting Node.js 20..."
        - nvm use 20 
        - echo "Node version: $(node -v)"
        - echo "NPM version: $(npm -v)"
        - echo "Installing root dependencies..."
        - npm ci # Install root dependencies based on lock file
  cache:
    paths:
      - node_modules/**/* # Cache root node_modules (relative to root)
      - packages/shared-types/dist/**/* # Cache shared-types build output (relative to root)

# Define the applications within the monorepo
applications:
  - # Configuration for the main frontend application
    appRoot: frontend 
    frontend:
      buildPath: '/'
      phases:
        # preBuild is handled globally
        build:
          commands:
            - echo "Building shared-types workspace (main app)..."
            - npm run build -w @usuaya/shared-types
            - echo "Building frontend workspace (main app)..."
            - npm run build -w frontend
      artifacts:
        baseDirectory: frontend/.next 
        files:
          - '**/*'
      # Cache defined globally

  - # Configuration for the amplify-test application
    appRoot: amplify-test # Root directory for this app
    frontend:
      buildPath: '/' # Also build from the monorepo root
      phases:
        # preBuild is handled globally
        build:
          commands:
            - echo "Building amplify-test workspace..."
            # Use workspace command with npx
            - npm run build -w amplify-test-app # Uses script: "npx next build"
      artifacts:
        # Path relative to the project root
        baseDirectory: amplify-test/.next 
        files:
          - '**/*'
      # Cache defined globally
      cache:
        paths:
          # Cache root node_modules again (might be redundant but safe)
          - node_modules/**/* 